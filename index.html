<!-- Keep your TFJS + TM libs -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
  // Load from your own repo (no external TM URL)
  const modelURL = "./model/model.json";
  const metadataURL = "./model/metadata.json";

  let model, webcam, labelContainer, maxPredictions;

  const setStatus = (t) => {
    let el = document.getElementById("status");
    if (!el) {
      el = document.createElement("div");
      el.id = "status";
      document.body.insertBefore(el, document.getElementById("webcam-container"));
    }
    el.textContent = t;
  };

  async function init() {
    try {
      setStatus("Loading model…");
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // 224×224 matches your model’s imageSize
      const flip = true;
      webcam = new tmImage.Webcam(224, 224, flip);
      setStatus("Requesting camera permission…");
      await webcam.setup({ facingMode: "user" });
      await webcam.play();
      setStatus("Camera ready. Running predictions…");
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
    } catch (err) {
      console.error(err);
      setStatus("Error: " + (err?.message || String(err)));
    }
  }

  async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
  }

  async function predict() {
    const prediction = await model.predict(webcam.canvas);
    for (let i = 0; i < maxPredictions; i++) {
      const p = prediction[i];
      labelContainer.childNodes[i].textContent =
        `${p.className}: ${p.probability.toFixed(2)}`;
    }
  }
</script>
